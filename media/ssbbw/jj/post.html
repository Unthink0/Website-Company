<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Post</title>

<style>
:root{
  --bg:#0f0f0f;
  --panel:#1c1c1c;
  --muted:#bfbfbf;
  --accent:#007aff;
  --border: rgba(255,255,255,.10);
}

body{
  margin:0;
  background:var(--bg);
  color:var(--muted);
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  display:flex;
  justify-content:center;
}

.container{
  width:min(900px, 95%);
  margin:40px auto;
  background:var(--panel);
  border-radius:12px;
  padding:20px;
  box-shadow:0 8px 30px rgba(0,0,0,.6);
}

.notice{
  padding:12px 14px;
  background:#121212;
  border:1px solid var(--border);
  border-radius:10px;
  margin-bottom:14px;
  color:#ddd;
  font-size:.95rem;
}
.notice.error{
  border-color: rgba(255, 80, 80, .35);
  color:#ffd1d1;
}

img{
  width:100%;
  border-radius:10px;
  margin-bottom:16px;
  object-fit:cover;
}

h1{
  color:#fff;
  margin:0 0 8px;
}

.meta{
  font-size:.95rem;
  margin-bottom:12px;
  color:#ddd;
}

.desc{
  line-height:1.5;
  margin: 0 0 14px;
}

.details{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin: 10px 0 6px;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:999px;
  background:#121212;
  border:1px solid var(--border);
  color:#e6e6e6;
  font-size:.92rem;
}
.pill b{ color:#fff; font-weight:700; }

.watch-btn{
  display:inline-block;
  background:var(--accent);
  color:#fff;
  padding:14px 22px;
  border-radius:30px;
  font-weight:800;
  font-size:1rem;
  border:0;
  cursor:pointer;
  margin-top:14px;
  transition:background .2s ease, transform .2s ease;
}
.watch-btn:hover{
  background:#0091ff;
  transform:translateY(-2px);
}

.manual-link{
  display:inline-block;
  background:#007aff;
  color:#fff;
  padding:12px 18px;
  border-radius:999px;
  font-weight:800;
  text-decoration:none;
  margin-top:10px;
}

.back{
  display:inline-block;
  margin-top:22px;
  color:#aaa;
  text-decoration:none;
}
.back:hover{ text-decoration:underline; }
</style>
</head>

<body>
<div class="container">
  <div id="status" class="notice" style="display:none;"></div>
  <div id="post"></div>
</div>

<script>
const statusBox = document.getElementById("status");
const postWrap = document.getElementById("post");

function safe(v){ return (v ?? "").toString(); }

function showStatus(msg, isError=false){
  statusBox.style.display = "block";
  statusBox.textContent = msg;
  statusBox.classList.toggle("error", !!isError);
}

function hideStatus(){
  statusBox.style.display = "none";
  statusBox.textContent = "";
  statusBox.classList.remove("error");
  const fallback = document.getElementById("manualVideoLink");
  if (fallback) fallback.remove();
}

function getId(){
  const params = new URLSearchParams(window.location.search);
  const raw = params.get("id");
  const id = raw ? parseInt(raw, 10) : NaN;
  return Number.isFinite(id) ? id : null;
}

function joinMeta(parts){
  return parts.filter(Boolean).join(" \u2022 "); // bullet dot
}

function addManualFallback(url){
  if (document.getElementById("manualVideoLink")) return;

  const div = document.createElement("div");
  div.id = "manualVideoLink";
  div.innerHTML = `
    <div style="margin-top:10px;">
      <a class="manual-link" href="${url}" target="Video Player" rel="noopener noreferrer">
        Open Video Player
      </a>
    </div>
  `;
  statusBox.insertAdjacentElement("afterend", div);
}

async function loadPost(){
  const id = getId();
  if(id === null){
    showStatus("Missing or invalid post id.", true);
    return;
  }

  try{
    showStatus("Loading post...");
    const res = await fetch("./posts.json", { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);

    const posts = await res.json();
    const post = Array.isArray(posts) ? posts.find(p => p.id === id) : null;

    if(!post){
      showStatus("Post not found.", true);
      return;
    }

    hideStatus();
    document.title = safe(post.title) || "Post";

    const metaText = joinMeta([
      post.date ? safe(post.date) : "",
      post.category ? safe(post.category) : "",
      post.duration ? safe(post.duration) : ""
    ]);

    // Build page
    postWrap.innerHTML = `
      <img src="${safe(post.image)}" alt="${safe(post.title)}">
      <h1>${safe(post.title)}</h1>

      ${metaText ? `<div class="meta">${metaText}</div>` : ""}

      ${post.description ? `<p class="desc">${safe(post.description)}</p>` : ""}

      <div class="details">
        ${post.weight ? `<div class="pill"><b>Weight</b> ${safe(post.weight)}</div>` : ""}
        ${post.height ? `<div class="pill"><b>Height</b> ${safe(post.height)}</div>` : ""}
        ${post.bodyType ? `<div class="pill"><b>Body Type</b> ${safe(post.bodyType)}</div>` : ""}
      </div>

      ${
        post.watchUrl ? `
          <!-- Hidden link (more reliable than window.open on Safari) -->
          <a id="watchLink" href="${safe(post.watchUrl)}" target="Video Player" rel="noopener noreferrer" style="display:none;"></a>
          <button class="watch-btn" id="watchBtn" type="button">▶ Watch Video</button>
        ` : ""
      }

      <br>
      <a class="back" href="./">← Back to gallery</a>
    `;

    // Wire up Watch button
    if (post.watchUrl) {
      const btn = document.getElementById("watchBtn");
      const link = document.getElementById("watchLink");
      const url = safe(post.watchUrl);

      btn.addEventListener("click", () => {
        hideStatus();

        // If URL is invalid, show message
        if (!/^https?:\/\//i.test(url)) {
          showStatus("Video not loaded. Invalid video URL.", true);
          return;
        }

        // Best compatibility: simulate a user link click (works better on GitHub Pages/Safari)
        try {
          link.click();
        } catch (e) {
          // If click fails for any reason, show fallback
          showStatus("Video not loaded. Exit tab and try again.", true);
          addManualFallback(url);
          return;
        }

        // If the browser opens a blank tab or blocks popups, show helper text + manual link
        // (User can close the blank tab and click the fallback link)
        setTimeout(() => {
          showStatus("If the video didn’t load: exit the Video Player tab and try again. You may need to allow popups for this site.", true);
          addManualFallback(url);
        }, 200);
      });
    }

  } catch(err){
    console.error(err);
    showStatus("Could not load post. Please reload page.", true);
  }
}

window.addEventListener("DOMContentLoaded", loadPost);
</script>

<!-- Age gate on every page -->
<script src="age-gate.js"></script>
</body>
</html>
